<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Viewer</title>
    <!-- Include Leaflet CSS and JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <!-- Include Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"  crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body {
            display: flex;
            margin: 0;
        }

        #game-list {
            width: 20%;
            overflow-y: auto;
            padding: 10px;
            box-sizing: border-box;
            background-color: #f0f0f0;
            cursor: pointer; /* Set the cursor property */
        }

        .game-entry {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 4px;
            border-bottom: 1px solid #ccc;
        }

	.menuicons {
            /* Align the icons to the right */
            text-align: right;
	}
	
	.menuicons i {
            margin-left: 8px; /* Add some space between icons */
	}
	
	
        #map {
            flex: 1;
            height: 100vh;
        }
    </style>
</head>
<body>

<div id="game-list"></div>
<div id="map"></div>

<script>
  // Function to fetch and populate the game list
  function fetchAndPopulateGames() {
      fetch('/game')
          .then(response => response.json())
	  .then(games => {
	      const gameList = document.getElementById('game-list');
	      gameList.innerHTML = ''; // Clear existing entries
	      
	      games.forEach(game => {
		  const gameEntry = document.createElement('div');
		  gameEntry.className = 'game-entry';

                  // Game name
                  const gameName = document.createElement('div');
		  gameName.textContent = game.name;
		  gameName.addEventListener("click", () => loadGame(game));

                  // Delete icon
		  const icons = document.createElement('div');
		  icons.className = "menuicons";
		  
                  const deleteIcon = document.createElement('i');
                  deleteIcon.className = 'fas fa-trash-alt menuicon';
                  deleteIcon.addEventListener('click', () => deleteGame(game));

                  // Edit icon
                  const editIcon = document.createElement('i');
                  editIcon.className = 'fas fa-edit menuicon';
                  editIcon.addEventListener('click', () => editGame(game));

                  const goIcon = document.createElement('i');
                  goIcon.className = 'fas fa-plane-departure menuicon';
                  goIcon.addEventListener('click', () => createGame(game));
		  
                  gameEntry.appendChild(gameName);
                  icons.appendChild(deleteIcon);
		  icons.appendChild(editIcon);
		  icons.appendChild(goIcon);
		  gameEntry.appendChild(icons);
                  gameList.appendChild(gameEntry);
              });
	      b1 = document.createElement('button');
	      b1.textContent = "Refresh";
	      b1.addEventListener('click', () => fetchAndPopulateGames());

	      b2 = document.createElement('button');
	      b2.textContent = "New";
	      b2.addEventListener('click', () => newGame());
	      
	      gameList.appendChild(b1);
	      gameList.appendChild(b2);
          })
          .catch(error => console.error('Error fetching games:', error));
  }

  function createGame(game) {
      
      fetch('/instance/'+game.id, {
	  method: 'POST',
	  headers: {
	      'Content-Type': 'application/json',
          },
	  body: JSON.stringify({
              name: prompt('Enter a name:', "CTF-XX"),
          }),
        })
	  .then(response => response.json())
	  .then(igame => {
	      if (igame && igame.igame && igame.igame.id) {
		  window.location = "/igame.html#"+igame.igame.id;
	      }
	      else {
		  alert("Error creating a CTF");
	      }
	  }
	       );
      
  }
  
  // Function to delete a game (you can implement this)
  function deleteGame(game) {
      // Implement the delete game functionality
      console.log('Delete game:', game);
      fetch('/game/'+game.id, {
            method: 'DELETE' ,
            headers: {
                'Content-Type': 'application/json',
            }
        })
            .then(response => {
		if (response.ok) {
		    response.json().then(body => { current_game = body.game })
                    console.log('Game deleted successfully!');
		} else {
                    console.error('Failed to save game:', response.statusText);
		}
		
		// After deletion, refresh the game list
		fetchAndPopulateGames();
            })
            .catch(error => console.error('Error during fetch:', error));
      
  }

  // Function to edit a game (you can implement this)
  function editGame(game) {
      // Implement the edit game functionality
      window.location = '/static/editor.html#'+game.id;
      console.log('Edit game:', game);
      // After editing, refresh the game list
      fetchAndPopulateGames();
  }

  function newGame() {
      window.location='/static/editor.html';
  }
  
  // Load and display the selected game on the map
  function loadGame(game) {
      // Clear existing markers on the map
      if (map) {
          markers.forEach(marker => map.removeLayer(marker));
          markers = [];
      }

      // Create new markers for the cylinders of the selected game
      game.cylinders.forEach(cylinder => {
          const marker = L.circle([cylinder.latitude, cylinder.longitude], {
              radius: cylinder.radius,
              color: 'blue',
              fillOpacity: 0.4
          }).addTo(map);
          markers.push(marker);
      });

      // Fit the map to the bounding box of all cylinders
      if (markers.length > 0) {
	  pad = 100;

          const bounds = new L.LatLngBounds(markers.map(marker => marker.getLatLng()));
          map.fitBounds(bounds, { padding: [pad, pad]});
      }
  }

  var map = L.map('map').setView([0, 0], 2);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  var markers = [];

  // Initial fetch and populate
  fetchAndPopulateGames();
</script>

</body>
</html>
